var access = "http://www.die2nite.com/tid/graph/me?fields=name,dead"
                +",map.fields(id,wid,hei,citizens"
                    +",zones.fields(details,items,building)"
                    +",city.fields(name)"
                +")"
var async = require('async')
var auth  = require('twinauth')(access, "www.die2nite.com")

this.go = auth.go
this.back = auth.back

this.out = function(req, res, next){
    req.session.destroy()
    req.session = null
    req.json = null
    res.redirect("/")
}
this.parse = function(req, res, next){
    req.session.me = {name: req.json.name}
    if(typeof(req.json.map) == "undefined") return next()
    req.session.city = req.json.map.city
    map = []
    comp = {}
    for(y=0,h=req.json.map.hei; y<h; ++y){
        map[y] = []
        for(x=0,w=req.json.map.wid; x<w; ++x){
            map[y][x] = {z:-1}
        }
    }
    async.each(req.json.map.zones, function(zone, ok){
        map[zone.y][zone.x] = zone
        items = zone.items
        for(i=0,l=items.length; i<l; ++i){
            if(typeof(comp[items[i].cat]) == "undefined") 
                comp[items[i].cat] = []
            items[i].x = zone.x
            items[i].y = zone.y
            comp[items[i].cat].push(items[i])
        }
        ok()
    }, function(err){
        map[req.json.map.city.y][req.json.map.city.x].city = true;
        map.hei = req.json.map.hei
        map.wid = req.json.map.wid
        req.session.map = map
        req.session.comp = comp
        next(err)
    })
}
