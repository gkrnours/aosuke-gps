var access = "http://www.hordes.fr/tid/graph/me?fields=name,dead"
                +",map.fields(id,wid,hei,citizens"
                    +",zones.fields(details,items,building)"
                    +",city.fields(name)"
                +")"
var async = require('async')
var auth  = require('twinauth')(access, "www.hordes.fr")

this.go = auth.go
this.back = auth.back

this.out = function(req, res, next){
    req.session.destroy()
    req.session = null
    req.json = null
    res.redirect("/")
}
this.parse = function(req, res, next){
    req.session.me = {name: req.json.name}
    if(typeof(req.json.map) == "undefined") return next()
    req.session.city = req.json.map.city
    map = []
    for(y=0,h=req.json.map.hei; y<h; ++y){
        map[y] = []
        for(x=0,w=req.json.map.wid; x<w; ++x){
            map[y][x] = {z:-1}
        }
    }
    async.each(req.json.map.zones, function(zone, ok){
        map[zone.y][zone.x] = zone
        ok()
    }, function(err){
        map[req.json.map.city.y][req.json.map.city.x].city = true;
        req.session.map = map;
        next(err)
    })
}
